name: CI

on:
  push:
    branches: [main]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

jobs:
  build:
    name: Build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: oven-sh/setup-bun@v2
      - run: bun install --frozen-lockfile
      - run: bun run build

  changesets:
    name: Changesets
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    outputs:
      hasChangesets: ${{ steps.changesets.outputs.hasChangesets }}
    steps:
      - uses: actions/checkout@v6
      - uses: oven-sh/setup-bun@v2
      - run: bun install --frozen-lockfile
      - uses: changesets/action@v1
        id: changesets
        with:
          version: bun run version
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  release:
    name: Release
    needs: changesets
    if: needs.changesets.outputs.hasChangesets == 'false'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v6
      - uses: oven-sh/setup-bun@v2
      - run: bun install --frozen-lockfile
      - run: bun run build

      - name: Create GitHub Releases
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          for dir in apis/*/; do
            name=$(basename "$dir")
            version=$(jq -r '.version' "$dir/package.json")
            tag="${name}/v${version}"

            if gh release view "$tag" > /dev/null 2>&1; then
              echo "Release $tag already exists, skipping"
              continue
            fi

            schema_file="$dir/tsp-output/schema.json"
            if [ ! -f "$schema_file" ]; then
              echo "No schema.json found for $name, skipping"
              continue
            fi

            gh release create "$tag" "$schema_file" \
              --title "$name v$version" \
              --notes "JSON Schema for $name API messages." \
              --latest=false
            echo "Created release $tag"
          done
