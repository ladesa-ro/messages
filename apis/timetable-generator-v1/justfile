set dotenv-load := true

root := justfile_directory()
schema_dir := root / "json-schema"
schema_out := schema_dir / "lib"
ts_dir := root / "integrations" / "typescript"
cs_dir := root / "integrations" / "dotnet" / "Ladesa.Messages.TimetableGenerator.V1"

# Lista comandos disponíveis
default:
    @just --list

# ========================================
# Build
# ========================================

# Build completo (schema + integrações)
build: build-schema build-ts build-cs

# Gera JSON Schema via TypeSpec
build-schema:
    cd "{{ schema_dir }}" && bun install --frozen-lockfile && bun run build

# Gera TypeScript via quicktype
build-ts:
    mkdir -p "{{ ts_dir }}/lib"
    cd "{{ schema_dir }}" && bunx quicktype \
        --src-lang schema \
        '{{ schema_out }}/schema.json#/$defs/' \
        -o "{{ ts_dir }}/lib/out.ts"

# Gera C# via quicktype
build-cs:
    mkdir -p "{{ cs_dir }}/Generated"
    cd "{{ schema_dir }}" && bunx quicktype \
        --src-lang schema \
        '{{ schema_out }}/schema.json#/$defs/' \
        -o "{{ cs_dir }}/Generated/Messages.cs" \
        --namespace Ladesa.Messages.TimetableGenerator.V1 \
        --framework SystemTextJson

# ========================================
# Desenvolvimento
# ========================================

# Watch mode para TypeSpec
watch:
    cd "{{ schema_dir }}" && bun run --watch build

# Limpa artefatos gerados
clean:
    rm -rf "{{ schema_out }}"
    rm -rf "{{ ts_dir }}/lib"
    rm -rf "{{ cs_dir }}/Generated"
    rm -rf "{{ cs_dir }}/bin"
    rm -rf "{{ cs_dir }}/obj"
